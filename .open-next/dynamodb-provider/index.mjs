globalThis.openNextDebug = false;globalThis.openNextVersion = "3.7.7";
var Y=Object.defineProperty;var a=(e,t)=>()=>(e&&(t=e(e=0)),t);var f=(e,t)=>{for(var r in t)Y(e,r,{get:t[r],enumerable:!0})};function m(e){try{return"__openNextInternal"in e}catch{return!1}}var h=a(()=>{});function i(...e){globalThis.openNextDebug&&console.log(...e)}function v(...e){console.warn(...e)}function s(...e){if(e.some(t=>K(t)))return i(...e);if(e.some(t=>m(t))){let t=e.find(r=>m(r));return t.logLevel<$()?void 0:t.logLevel===0?console.log(...e.map(r=>m(r)?`${r.name}: ${r.message}`:r)):t.logLevel===1?v(...e.map(r=>m(r)?`${r.name}: ${r.message}`:r)):console.error(...e)}console.error(...e)}function $(){switch((process.env.OPEN_NEXT_ERROR_LOG_LEVEL??"1").toLowerCase()){case"debug":case"0":return 0;case"error":case"2":return 2;default:return 1}}var P,K,E,y=a(()=>{h();P=[{clientName:"S3Client",commandName:"GetObjectCommand",errorName:"NoSuchKey"}],K=e=>P.some(t=>t.clientName===e?.clientName&&t.commandName===e?.commandName&&(t.errorName===e?.error?.name||t.errorName===e?.error?.Code));E={trace:()=>{},debug:()=>{},info:i,warn:v,error:s}});var w={};f(w,{default:()=>z});var G,z,T=a(()=>{G={convertFrom(e){return Promise.resolve({type:"dummy",original:e})},convertTo(e){return Promise.resolve({type:"dummy",original:e})},name:"dummy"},z=G});var A={};f(A,{default:()=>j,formatWarmerResponse:()=>b});import{Writable as V}from"node:stream";function b(e){return new Promise(t=>{setTimeout(()=>{t({serverId,type:"warmer"})},e.delay)})}var X,j,D=a(()=>{X=async(e,t)=>async r=>{if("type"in r)return b(r);let n=await t.convertFrom(r),c=await e(n,{streamCreator:{writeHeaders:()=>new V({write:(u,x,U)=>{U()}})}});return t.convertTo(c,r)},j={wrapper:X,name:"aws-lambda",supportStreaming:!1}});function g(e,t){return e.reduce((n,o,c)=>{let u=Math.floor(c/t);return n[u]=[...n[u]??[],o],n},new Array)}function I(e){if(typeof e!="string")return e;let t=Number.parseInt(e);return Number.isNaN(t)?void 0:t}var O=a(()=>{});var S,R=a(()=>{S=()=>{let e=process.env.DYNAMO_BATCH_WRITE_COMMAND_CONCURRENCY,t=e?Number.parseInt(e):void 0;return t&&!Number.isNaN(t)?t:4}});var L={};f(L,{default:()=>oe});import Q from"node:path";import{BatchWriteItemCommand as J,DynamoDBClient as Z,QueryCommand as N}from"@aws-sdk/client-dynamodb";function te(){return{region:ee,logger:E,maxAttempts:I(process.env.AWS_SDK_DYNAMODB_MAX_ATTEMPTS)}}function p(e){return Q.posix.join(_??"",e)}function re(e,t,r){return{path:{S:p(e)},tag:{S:p(t)},revalidatedAt:{N:`${r??Date.now()}`}}}var ee,l,_,d,ne,oe,M=a(()=>{y();O();R();({CACHE_BUCKET_REGION:ee,CACHE_DYNAMO_TABLE:l,NEXT_BUILD_ID:_}=process.env);d=new Z(te());ne={mode:"original",async getByPath(e){try{if(globalThis.openNextConfig.dangerous?.disableTagCache)return[];let r=(await d.send(new N({TableName:l,IndexName:"revalidate",KeyConditionExpression:"#key = :key",ExpressionAttributeNames:{"#key":"path"},ExpressionAttributeValues:{":key":{S:p(e)}}}))).Items?.map(n=>n.tag.S??"")??[];return i("tags for path",e,r),r.map(n=>n.replace(`${_}/`,""))}catch(t){return s("Failed to get tags by path",t),[]}},async getByTag(e){try{if(globalThis.openNextConfig.dangerous?.disableTagCache)return[];let{Items:t}=await d.send(new N({TableName:l,KeyConditionExpression:"#tag = :tag",ExpressionAttributeNames:{"#tag":"tag"},ExpressionAttributeValues:{":tag":{S:p(e)}}}));return t?.map(({path:{S:r}})=>r?.replace(`${_}/`,"")??"")??[]}catch(t){return s("Failed to get by tag",t),[]}},async getLastModified(e,t){try{if(globalThis.openNextConfig.dangerous?.disableTagCache)return t??Date.now();let n=(await d.send(new N({TableName:l,IndexName:"revalidate",KeyConditionExpression:"#key = :key AND #revalidatedAt > :lastModified",ExpressionAttributeNames:{"#key":"path","#revalidatedAt":"revalidatedAt"},ExpressionAttributeValues:{":key":{S:p(e)},":lastModified":{N:String(t??0)}}}))).Items??[];return i("revalidatedTags",n),n.length>0?-1:t??Date.now()}catch(r){return s("Failed to get revalidated tags",r),t??Date.now()}},async writeTags(e){try{if(globalThis.openNextConfig.dangerous?.disableTagCache)return;let t=g(e,25).map(n=>({RequestItems:{[l??""]:n.map(o=>({PutRequest:{Item:{...re(o.path,o.tag,o.revalidatedAt)}}}))}})),r=g(t,S());for(let n of r)await Promise.all(n.map(async o=>d.send(new J(o))))}catch(t){s("Failed to batch write dynamo item",t)}},name:"dynamoDb"},oe=ne});import{readFileSync as ae}from"node:fs";y();async function k(e){return typeof e=="function"?e():(await Promise.resolve().then(()=>(T(),w))).default}async function F(e){return typeof e=="function"?e():(await Promise.resolve().then(()=>(D(),A))).default}async function B(e){return typeof e=="function"?e():(await Promise.resolve().then(()=>(M(),L))).default}async function W(e){let t=await import("./open-next.config.mjs").then(x=>x.default);globalThis.openNextConfig=t;let r=t[e.type],n=r&&"override"in r?r.override:void 0,o=await k(n?.converter),{name:c,wrapper:u}=await F(n?.wrapper);return i("Using wrapper",c),u(e.handler,o)}var C="dynamodb-cache",H=await B(globalThis.openNextConfig?.initializationFunction?.tagCache),De=await W({handler:ie,type:"initializationFunction"});async function ie(e){switch(e.requestType){case"delete":return ce();default:return se(e.requestType)}}async function se(e){if(H.mode==="nextMode")return{type:"initializationFunction",requestType:e,resourceId:C};let t=ae("dynamodb-cache.json","utf8"),n=JSON.parse(t).map(o=>({tag:o.tag.S,path:o.path.S,revalidatedAt:Number.parseInt(o.revalidatedAt.N)}));return await H.writeTags(n),{type:"initializationFunction",requestType:e,resourceId:C}}async function ce(){return{type:"initializationFunction",requestType:"delete",resourceId:C}}export{De as handler};
